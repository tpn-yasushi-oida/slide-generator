<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>まじん式スライドジェネレーター</title>
  </head>
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0..1,-25..0"
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400&family=Material+Symbols+Outlined&family=Reddit+Sans:wght@400;500&display=swap"
    rel="stylesheet"
  />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      color: #333;
      padding: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }

    header h1 {
      font-family: "Reddit Sans", sans-serif;
      font-size: 2.2rem;
      font-weight: 500;
      letter-spacing: 0.1rem;
      margin: 0;
      padding-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    header .subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      font-weight: 400;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 35px;
      text-align: center;
      font-size: 0.875rem;
      color: rgba(255,255,255,0.8);
      padding: 0.5rem 0;
      z-index: 10;
      background: rgba(0,0,0,0.1);
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }

    .container h2 {
      padding: 10px 0 30px 0;
      text-align: center;
      color: #4a5568;
      font-size: 1.4rem;
      font-weight: 400;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      font-size: 1rem;
      font-weight: 500;
      color: #2d3748;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    textarea {
      width: 100%;
      padding: 18px 24px;
      font-size: 0.95rem;
      outline: none;
      background: #f8f9fa;
      transition: all 0.3s ease;
      color: #333;
      border: 2px solid #e2e8f0;
      border-radius: 15px;
      line-height: 1.6;
      resize: vertical;
    }
    
    textarea:focus {
      border-color: #667eea;
      background: #ffffff;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn-area {
      text-align: center;
      vertical-align: middle;
      margin-top: 10px;
    }

    .submit-btn {
      height: 55px;
      width: 200px;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      border-radius: 15px;
      font-size: 1.05rem;
      cursor: pointer;
      transition: all 0.3s ease;
      letter-spacing: 0.5px;
      margin: 10px 15px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }
    
    .submit-btn:active {
      transform: translateY(0);
    }


    #link-to-slide {
      width: 300px;
      background: linear-gradient(135deg, #ffdd00 0%, #ffa500 100%);
      color: #333;
      font-weight: bold;
      margin-top: 30px;
      display: none;
      box-shadow: 0 4px 15px rgba(255, 221, 0, 0.4);
    }

    #link-to-slide:hover {
      box-shadow: 0 8px 25px rgba(255, 221, 0, 0.6);
    }

    /* ローディング */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .loading-content {
      text-align: center;
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 6px solid rgba(102, 126, 234, 0.2);
      border-top: 6px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    #loading p {
      margin-top: 20px;
      font-size: 1.1rem;
      color: #333;
      font-weight: 500;
    }

    #loading button {
      margin-top: 25px;
      padding: 12px 24px;
      background-color: #ff5722;
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }

    #loading button:hover {
      background-color: #e64a19;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    /* カスタムアラート */
    #custom-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: 999;
      display: none;
      backdrop-filter: blur(5px);
    }

    #custom-alert {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
    }

    #custom-alert .alert-content {
      text-align: center;
    }

    #custom-alert button {
      margin-top: 25px;
      padding: 12px 20px;
      background-color: #667eea;
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #custom-alert button:hover {
      background-color: #5a67d8;
    }

    .feature-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-left: 8px;
    }

    .description-box {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      padding: 16px 20px;
      margin-bottom: 20px;
      border-radius: 0 10px 10px 0;
    }

    .description-box h3 {
      color: #2d3748;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }

    .description-box p {
      color: #4a5568;
      line-height: 1.5;
      margin: 4px 0;
    }
  </style>
  <body>
    <header>
      <h1>まじん式スライドジェネレーター</h1>
      <p class="subtitle">AI駆動でプロフェッショナルなGoogleスライドを自動生成</p>
    </header>
    <div class="container">
      <h2>まじん式スライドジェネレーター テスト</h2>
      
      <div class="description-box">
        <h3>🎯 まじん式の特徴</h3>
        <p>• <strong>Google風デザイン:</strong> 美しく統一されたデザインテンプレート</p>
        <p>• <strong>多彩な表現:</strong> 比較、プロセス、タイムライン、カードなど豊富なパターン</p>
        <p>• <strong>スピーカーノート:</strong> 発表原稿も自動生成</p>
        <p>• <strong>構造化AI:</strong> Gemini最新モデルによる高精度生成</p>
      </div>

      <form onsubmit="event.preventDefault();">
        <div class="form-group">
          <label class="form-label" for="prompt">
            <span class="material-symbols-outlined">edit_note</span>
            プレゼンテーション内容
            <span class="feature-badge">必須</span>
          </label>
          <textarea
            id="prompt"
            rows="15"
            placeholder="作成したいプレゼンテーションの内容を入力してください。

テスト例：
・シンプルなテーマ：「チームワークの重要性」
・詳細な内容：
  プロジェクト進捗報告
  1. 現在の状況
     - 完了タスク：設計、開発フェーズ1
     - 進行中：テスト、ドキュメント作成
  2. 課題と対策
     - スケジュール遅延：リソース追加で対応
     - 品質保証：テスト強化
  3. 今後の予定
     - 来月：リリース準備
     - 来々月：本格運用開始"
          ></textarea>
        </div>
        <div class="form-group">
          <label class="form-label" for="generate-option">
            <span class="material-symbols-outlined">tune</span>
            詳細設定・要望
            <span class="feature-badge">任意</span>
          </label>
          <textarea
            id="generate-option"
            rows="3"
            placeholder="プレゼンテーションの詳細要望を入力してください。
例）社内研修用、10分程度、具体例重視、聞き手との対話形式"
          ></textarea>
        </div>
        <div class="btn-area">
          <button
            type="submit"
            id="test-generate"
            class="submit-btn"
            onclick="handleSubmit(event)"
          >
            <span class="material-symbols-outlined">science</span>テスト生成
          </button>
        </div>
      </form>

      <div id="loading">
        <div class="loading-content">
          <div class="spinner"></div>
          <p>まじん式AIがスライドを生成中...</p>
          <button id="cancel-loading" onclick="cancelLoading()">
            キャンセル
          </button>
        </div>
      </div>
      <div id="custom-alert-overlay">
        <div id="custom-alert">
          <div class="alert-content">
            <p id="custom-alert-message">メッセージがここに表示されます</p>
            <button onclick="hideCustomAlert()">閉じる</button>
          </div>
        </div>
      </div>

      <div class="btn-area">
        <button
          id="link-to-slide"
          class="submit-btn"
          onclick="window.open('', '_blank');"
        >
          <span class="material-symbols-outlined">open_in_new</span>
          スライドを開く
        </button>
      </div>
    </div>
    <footer>© 2025 まじん式スライドジェネレーター - Powered by Gemini AI</footer>
  </body>
  <script>
    let isCancelled = false; // キャンセルフラグ

    // キャンセルボタンの処理
    function cancelLoading() {
      isCancelled = true; // キャンセルフラグを立てる
      const loadingElement = document.getElementById("loading");
      if (loadingElement) {
        loadingElement.style.display = "none"; // ローディング画面を非表示
      }
      showCustomAlert("処理がキャンセルされました。");
    }

    async function handleSubmit(event) {
      event.preventDefault(); // フォーム送信のリロードを防止

      // 押されたボタンのIDを取得
      const buttonId = event.target.id;

      // リンクボタンを非表示
      const linkButton = document.getElementById("link-to-slide");
      if (linkButton) {
        linkButton.style.display = "none";
      }

      // ローディング画面を表示
      const loadingElement = document.getElementById("loading");
      if (loadingElement) {
        loadingElement.style.display = "flex";
      }

      // パラメータ取得
      const prompt = document.getElementById("prompt")?.value || undefined;
      const generateOption =
        document.getElementById("generate-option")?.value || undefined;

      if (!prompt) {
        if (loadingElement) {
          loadingElement.style.display = "none";
        }
        showCustomAlert("プレゼンテーション内容が未入力です。内容を入力して再度実行してください。");
        return;
      }

      // ボタンIDに応じた処理
      let apiMethod;
      if (buttonId === "test-generate") {
        console.log("テスト生成を実行");
        apiMethod = "mainCustom"; // カスタム生成用のGoogle Apps Script関数を使用
      } else {
        console.error("不明なボタンIDです");
        if (loadingElement) {
          loadingElement.style.display = "none";
        }
        showCustomAlert("不明な操作が行われました。再度お試しください。");
        return;
      }

      isCancelled = false; // 処理開始時にキャンセルフラグをリセット

      google.script.run
        .withSuccessHandler((response) => {
          if (isCancelled) {
            console.log("キャンセルされたため処理を停止");
            return;
          }
          console.log("成功:", response);
          if (loadingElement) {
            loadingElement.style.display = "none";
          }
          showCustomAlert("✨ まじん式スライド生成が完了しました！\n\nGoogle風デザインで美しいプレゼンテーションが作成されました。");
          // リンクを更新
          if (linkButton) {
            linkButton.onclick = () => window.open(response, "_blank"); // リンクをGoogle Apps Scriptの結果に設定
            linkButton.style.display = "inline-flex";
          }
        })
        .withFailureHandler((error) => {
          if (isCancelled) {
            console.log("キャンセルされたためエラー処理を無視");
            return;
          }
          console.error("エラー:", error);
          if (loadingElement) {
            loadingElement.style.display = "none";
          }
          showCustomAlert("❌ エラーが発生しました。\n\n以下をご確認ください：\n• インターネット接続\n• Gemini API設定\n• 入力内容の妥当性\n\nしばらく時間をおいて再度お試しください。");
        })
        [apiMethod](prompt, generateOption); // テスト生成実行

      google.script.run.outputLog(prompt, generateOption, buttonId);
    }

    // カスタムアラートを表示する
    function showCustomAlert(message) {
      const alertOverlay = document.getElementById("custom-alert-overlay");
      const alertMessageElement = document.getElementById(
        "custom-alert-message"
      );

      if (alertOverlay && alertMessageElement) {
        alertMessageElement.textContent = message; // メッセージを設定
        alertOverlay.style.display = "block"; // 半透明の膜とアラートを表示
      }
    }

    // カスタムアラートを非表示にする
    function hideCustomAlert() {
      const alertOverlay = document.getElementById("custom-alert-overlay");
      if (alertOverlay) {
        alertOverlay.style.display = "none"; // 非表示
      }
    }

    // ページ読み込み時の初期化
    document.addEventListener('DOMContentLoaded', function() {
      // プレースホルダーのアニメーション効果など、必要に応じて追加
      console.log('まじん式スライドジェネレーター初期化完了');
    });
  </script>
</html>
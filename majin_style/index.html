<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SlideGenerator2</title>
  </head>
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0..1,-25..0"
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400&family=Material+Symbols+Outlined&family=Reddit+Sans:wght@400;500&display=swap"
    rel="stylesheet"
  />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      color: #333;
      padding: 24px;
    }

    header {
      text-align: left;
      margin-bottom: 40px;
      margin-left: 0;
    }

    header h1 {
      font-family: "Reddit Sans", sans-serif;
      font-size: 1.4rem;
      font-weight: 400;
      letter-spacing: 0.1rem;
      color: rgb(127, 127, 127);
      margin: 0;
      padding-bottom: 5px;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 35px; /* 固定高さ */
      text-align: center;
      font-size: 0.875rem;
      color: #6c757d;
      padding: 0.5rem 0;
      z-index: 10;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 30px;
    }
    .container h1 {
      padding: 5px 0;
      text-align: center;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    textarea {
      width: 100%;
      padding: 15px 30px;
      font-size: 0.9rem;
      outline: none;
      background: #f4f4f4;
      transition: border-color 0.2s;
      color: #333;
      border: none;
      border-radius: 15px;
      line-height: 1.5;
    }
    textarea:focus {
      border-color: #333;
    }
    .btn-area {
      text-align: center;
      vertical-align: middle;
    }

    .submit-btn {
      height: 50px;
      width: 180px;
      padding: 14px;
      background-color: #111;
      color: #fff;
      border: none;
      border-radius: 15px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
      letter-spacing: 0.5px;
      margin: 10px 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .submit-btn:hover {
      transform: scale(1.05);
    }
    .submit-btn:active {
      transform: scale(0.98);
    }

    #link-to-slide {
      width: 400px;
      background-color: #ffdd00;
      color: #111;
      font-weight: bold;
      margin-top: 40px;
      display: none;
    }

    /* ローディング */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8); /* 半透明の白 */
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .loading-content {
      text-align: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 6px solid rgba(0, 0, 0, 0.2); /* 薄い枠 */
      border-top: 6px solid #111; /* 濃い部分 */
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto; /* 中央揃え */
    }

    #loading p {
      margin-top: 10px;
      font-size: 1rem;
      color: #333;
    }

    /* キャンセルボタン */
    #loading button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #ff5722;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      font-size: 1rem;
    }

    #loading button:hover {
      background-color: #e64a19;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    /* カスタムアラート */
    #custom-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8); /* 半透明の白 */
      z-index: 999; /* 他の要素の上に表示 */
      display: none; /* 初期状態では非表示 */
    }

    #custom-alert {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000; /* 膜の上に配置 */
      background: rgba(0, 0, 0, 0.8); /* 黒背景 */
      color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    #custom-alert .alert-content {
      text-align: center;
    }

    #custom-alert button {
      margin-top: 25px;
      padding: 10px 15px;
      background-color: #ff5722;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }

    #custom-alert button:hover {
      background-color: #e64a19;
    }
  </style>
  <body>
    <header>
      <h1>SlideGenerator2</h1>
    </header>
    <div class="container">
      <form onsubmit="event.preventDefault();">
        <div class="main-message">
          <h1>プレゼンテーションのイメージを教えてください</h1>
        </div>
        <div class="form-group">
          <textarea
            id="prompt"
            rows="17"
            placeholder="作成したいプレゼンテーションの内容を入力してください。

a. おまかせ生成の場合
    タイトルやテーマを入力してください。AIが補完してプレゼンテーションを作成します。
    例）生成AIとは

b. カスタム生成の場合
    スライドに含めたい内容をできるだけ細かく記述してください。
    メモ書きをそのまま貼り付けても実行できます。
    例）生成AIとは
        1. 生成AIの仕組み
        2. 生成AIでできる10のこと
            文章作成
            アイディア出し
            （残りは自動で生成）
        ..."
          ></textarea>
        </div>
        <div class="form-group">
          <textarea
            id="generate-option"
            rows="2"
            placeholder="作成したいプレゼンテーションの詳細、使用用途、内容の要望を入力してください。
    例）部内の共有会で話す用、スライド5枚程度、冒頭で聞き手に問いかける形式、具体例多め"
          ></textarea>
        </div>
        <div class="btn-area">
          <button
            type="submit"
            id="test-generate"
            class="submit-btn"
            onclick="handleSubmit(event)"
          >
            テスト生成
          </button>
        </div>
      </form>

      <div id="loading">
        <div class="loading-content">
          <div class="spinner"></div>
          <p>作成中...</p>
          <button id="cancel-loading" onclick="cancelLoading()">
            キャンセル
          </button>
        </div>
      </div>
      <div id="custom-alert-overlay">
        <div id="custom-alert">
          <div class="alert-content">
            <p id="custom-alert-message">メッセージがここに表示されます</p>
            <button onclick="hideCustomAlert()">閉じる</button>
          </div>
        </div>
      </div>

      <div class="btn-area">
        <button
          id="link-to-slide"
          class="submit-btn"
          onclick="window.open('', '_blank');"
        >
          <!-- 出力されたGSlideのリンクが入る -->
          <span class="material-symbols-outlined"> open_in_new </span
          >スライドをチェック
        </button>
      </div>
    </div>
    <footer>© 2025 TOPPAN Inc. AI Powered Project.</footer>
  </body>
  <script>
    let isCancelled = false; // キャンセルフラグ

    // キャンセルボタンの処理
    function cancelLoading() {
      isCancelled = true; // キャンセルフラグを立てる
      const loadingElement = document.getElementById("loading");
      if (loadingElement) {
        loadingElement.style.display = "none"; // ローディング画面を非表示
      }
      showCustomAlert("処理がキャンセルされました。");
    }

    async function handleSubmit(event) {
      event.preventDefault(); // フォーム送信のリロードを防止

      // 押されたボタンのIDを取得
      const buttonId = event.target.id;

      // リンクボタンを非表示
      const linkButton = document.getElementById("link-to-slide");
      if (linkButton) {
        linkButton.style.display = "none";
      }

      // ローディング画面を表示
      const loadingElement = document.getElementById("loading");
      if (loadingElement) {
        loadingElement.style.display = "flex";
      }

      // パラメータ取得
      const prompt = document.getElementById("prompt")?.value || undefined;
      const generateOption =
        document.getElementById("generate-option")?.value || undefined;

      if (!prompt) {
        if (loadingElement) {
          loadingElement.style.display = "none";
        }
        showCustomAlert("テキストが未入力です。入力して再度実行してください。");
        return;
      }

      // ボタンIDに応じた処理
      let apiMethod;
      if (buttonId === "test-generate") {
        console.log("テスト生成を実行");
        apiMethod = "mainTest"; // 単一ルート: テスト生成
      } else {
        console.error("不明なボタンIDです");
        if (loadingElement) {
          loadingElement.style.display = "none";
        }
        showCustomAlert("不明な操作が行われました。再度お試しください。");
        return;
      }

      isCancelled = false; // 処理開始時にキャンセルフラグをリセット

      google.script.run
        .withSuccessHandler((response) => {
          if (isCancelled) {
            console.log("キャンセルされたため処理を停止");
            return;
          }
          console.log("成功:", response);
          if (loadingElement) {
            loadingElement.style.display = "none";
          }
          showCustomAlert("スライド生成が完了しました！");
          // リンクを更新
          if (linkButton) {
            linkButton.onclick = () => window.open(response, "_blank"); // リンクをGoogle Apps Scriptの結果に設定
            linkButton.style.display = "inline-flex";
          }
        })
        .withFailureHandler((error) => {
          if (isCancelled) {
            console.log("キャンセルされたためエラー処理を無視");
            return;
          }
          console.error("エラー:", error);
          if (loadingElement) {
            loadingElement.style.display = "none";
          }
          showCustomAlert("エラーが発生しました。もう一度お試しください。");
        })
        [apiMethod](prompt, generateOption); // おまかせ生成かカスタム生成かで処理を分岐

      google.script.run.outputLog(prompt, generateOption, buttonId);
    }

    // カスタムアラートを表示する
    function showCustomAlert(message) {
      const alertOverlay = document.getElementById("custom-alert-overlay");
      const alertMessageElement = document.getElementById(
        "custom-alert-message"
      );

      if (alertOverlay && alertMessageElement) {
        alertMessageElement.textContent = message; // メッセージを設定
        alertOverlay.style.display = "block"; // 半透明の膜とアラートを表示
      }
    }

    // カスタムアラートを非表示にする
    function hideCustomAlert() {
      const alertOverlay = document.getElementById("custom-alert-overlay");
      if (alertOverlay) {
        alertOverlay.style.display = "none"; // 非表示
      }
    }
  </script>
</html>

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SlideGenerator2</title>
  </head>
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0..1,-25..0"
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400&family=Material+Symbols+Outlined&family=Reddit+Sans:wght@400;500&display=swap"
    rel="stylesheet"
  />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      color: #333;
    }

    header {
      text-align: left;
      margin-bottom: 40px;
      margin-left: 0;
    }

    header h1 {
      font-family: "Reddit Sans", sans-serif;
      font-size: 1.4rem;
      font-weight: 400;
      letter-spacing: 0.1rem;
      color: rgb(127, 127, 127);
      margin: 0;
      padding-bottom: 5px;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 35px; /* 固定高さ */
      text-align: center;
      font-size: 0.875rem;
      color: #6c757d;
      padding: 0.5rem 0;
      z-index: 10;
    }

    .container {
      margin: 0;
      background: #fff;
      padding: 30px;
      flex: 1;
    }
    
    .container h1 {
      padding: 5px 0;
      text-align: center;
      margin-bottom: 10px;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 20px;
      height: 100%;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .form-group textarea {
      width: 100%;
      height: 400px;
      resize: vertical;
      flex: 1;
    }

    textarea {
      width: 100%;
      padding: 15px 30px;
      font-size: 0.9rem;
      outline: none;
      background: #f4f4f4;
      transition: border-color 0.2s;
      color: #333;
      border: none;
      border-radius: 15px;
      line-height: 1.5;
    }
    textarea:focus {
      border-color: #333;
    }
    .btn-area {
      text-align: center;
      vertical-align: middle;
    }

    .btn-area-center {
      width: 100%;
      text-align: center;
      margin-top: 30px;
      margin-bottom: 30px;
    }

    .submit-btn {
      height: 50px;
      width: 180px;
      padding: 14px;
      background-color: #111;
      color: #fff;
      border: none;
      border-radius: 15px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
      letter-spacing: 0.5px;
      margin: 10px 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .submit-btn:hover {
      transform: scale(1.05);
    }
    .submit-btn:active {
      transform: scale(0.98);
    }

    #link-to-slide {
      width: 400px;
      background-color: #ffdd00;
      color: #111;
      font-weight: bold;
      margin-top: 40px;
      display: none;
    }

    /* ローディング */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8); /* 半透明の白 */
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .loading-content {
      text-align: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 6px solid rgba(0, 0, 0, 0.2); /* 薄い枠 */
      border-top: 6px solid #111; /* 濃い部分 */
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto; /* 中央揃え */
    }

    #loading p {
      margin-top: 10px;
      font-size: 1rem;
      color: #333;
    }

    /* キャンセルボタン */
    #loading button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #ff5722;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      font-size: 1rem;
    }

    #loading button:hover {
      background-color: #e64a19;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    /* カスタムアラート */
    #custom-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8); /* 半透明の白 */
      z-index: 999; /* 他の要素の上に表示 */
      display: none; /* 初期状態では非表示 */
    }

    #custom-alert {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000; /* 膜の上に配置 */
      background: rgba(0, 0, 0, 0.8); /* 黒背景 */
      color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    #custom-alert .alert-content {
      text-align: center;
    }

    #custom-alert button {
      margin-top: 25px;
      padding: 10px 15px;
      background-color: #ff5722;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }

    #custom-alert button:hover {
      background-color: #e64a19;
    }

    /* ページレイアウト */
    body {
      display: grid;
      grid-template-rows: auto auto auto;
      margin: 0;
      padding: 24px;
    }

    header {
      grid-column: 1 / -1;
      text-align: left;
      margin-bottom: 0;
      padding: 24px 0 20px 24px;
    }

    .page-title {
      text-align: center;
      margin: 20px 0 30px 0;
      padding: 0 24px;
    }

    .page-title h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .page-layout {
      display: grid;
      grid-template-columns: 3fr 2fr;
      gap: 20px;
    }

    .sidebar {
      width: 100%;
      padding: 24px 24px 24px 0;
      display: flex;
      flex-direction: column;
    }

    .main-area {
      display: flex;
      flex-direction: column;
    }

    /* サイドバーオプションのスタイリング */
    .options-section {
      background: #f4f4f4;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .options-title {
      font-family: "Reddit Sans", sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      color: #555;
      margin-bottom: 14px;
      text-align: center;
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 8px;
    }

    .options-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
      justify-content: flex-start;
    }

    .options-list .form-group {
      display: flex;
      flex-direction: column;
    }

    .options-list label {
      display: block;
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .text-input,
    .select-input {
      width: 100%;
      padding: 8px 12px;
      font-size: 0.75rem;
      outline: none;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      color: #333;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .text-input:focus,
    .select-input:focus {
      border-color: #111;
      box-shadow: 0 0 0 2px rgba(17, 17, 17, 0.1);
    }

    input[type="color"] {
      width: 60px;
      height: 32px;
      padding: 0;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      background: none;
    }

    input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 6px;
    }

    /* レスポンシブ対応 */
    @media (max-width: 768px) {
      body {
        grid-template-rows: auto auto 1fr;
      }

      .page-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }

      .sidebar {
        order: 2;
        padding: 20px 24px;
      }

      .main-area {
        order: 1;
      }

      header {
        padding: 20px 0 15px 24px;
      }

      .form-group textarea {
        height: 280px;
      }

      .options-section {
        padding: 14px;
      }

      .options-title {
        font-size: 0.8rem;
        margin-bottom: 12px;
      }

      .options-list {
        gap: 10px;
      }
    }

    @media (max-width: 600px) {
      .sidebar {
        padding: 15px 20px;
      }

      .container {
        padding: 20px;
      }

      .form-group textarea {
        height: 250px;
        padding: 12px 15px;
        font-size: 0.85rem;
      }

      .options-section {
        padding: 12px;
      }

      .text-input,
      .select-input {
        padding: 6px 10px;
        font-size: 0.7rem;
      }

      .options-list label {
        font-size: 0.7rem;
        margin-bottom: 4px;
      }

      .options-list {
        gap: 8px;
      }

      header {
        padding: 16px 0 12px 20px;
      }

      header h1 {
        font-size: 1.2rem;
      }
    }
  </style>
  <body>
    <header>
      <h1>SlideGenerator2</h1>
    </header>
    
    <!-- ページタイトル -->
    <div class="page-title">
      <h1>プレゼンテーションのイメージを教えてください</h1>
    </div>
    
    <div class="page-layout">
      <!-- 左: メインエリア -->
      <div class="main-area">
        <div class="container">
          <form onsubmit="event.preventDefault();">
            
            <div class="form-group">
              <textarea
              id="prompt"
              rows="15"
              placeholder="作成したいプレゼンテーションの内容を入力してください。
              
  スライドに含めたい内容をできるだけ細かく記述してください。
  メモ書きをそのまま貼り付けても実行できます。
    例）生成AIとは
    1. 生成AIの仕組み
    2. 生成AIでできる10のこと
    文章作成
    アイディア出し
  ..."
  ></textarea>
</div>
</form>
</div>
</div>

<!-- 右: サイドバー -->
<div class="sidebar">
        <div class="options-section">          
          <div class="options-list">
            <!-- primaryColor -->
            <div class="form-group">
              <label for="primary-color">メインカラー:</label>
              <input type="color" id="primary-color" value="#111111" />
            </div>
            <!-- fontFamily -->
            <div class="form-group">
              <label for="font-family">フォント:</label>
              <select id="font-family" class="select-input" onchange="handleFontFamilyChange()">
                <option value="BIZ UDPGothic">BIZ UDPGothic</option>
                <option value="Noto Sans JP">Noto Sans JP</option>
                <option value="IBM Plex Sans JP">IBM Plex Sans JP</option>
                <option value="Zen Kaku Gothic New">Zen Kaku Gothic New</option>
                <option value="Noto Serif JP">Noto Serif JP</option>
                <option value="Zen Kaku Gothic Antique">Zen Kaku Gothic Antique</option>
                <option value="M PLUS 1p">M PLUS 1p</option>
                <option value="Arial">Arial</option>
                <option value="Shippori Mincho">Shippori Mincho</option>
                <option value="Murecho">Murecho</option>
                <option value="Zen Maru Gothic">Zen Maru Gothic</option>
                <option value="M PLUS Rounded 1c">M PLUS Rounded 1c</option>
                <option value="Kaisei Opti">Kaisei Opti</option>
                <option value="Hina Mincho">Hina Mincho</option>
                <option value="Kaisei Decol">Kaisei Decol</option>
                <option value="Dela Gothic One">Dela Gothic One</option>
                <option value="custom">その他（カスタム入力）</option>
              </select>
              <input
                type="text"
                id="custom-font-family"
                placeholder="フォントファミリー名を正確に入力"
                class="text-input"
                style="display: none; margin-top: 8px;"
              />
            </div>

            
            <!-- footerText -->
            <div class="form-group">
              <label for="footer-text">フッターテキスト:</label>
              <input 
                type="text" 
                id="footer-text" 
                placeholder="© TOPPAN Inc." 
                value="© TOPPAN Inc."
                class="text-input"
              />
            </div>
            
            <!-- headerLogoUrl -->
            <div class="form-group">
              <label for="header-logo-url">ヘッダーロゴURL:</label>
              <input 
                type="url" 
                id="header-logo-url" 
                placeholder="https://example.com/logo.png"
                class="text-input"
              />
            </div>
            
            <!-- closingLogoUrl -->
            <div class="form-group">
              <label for="closing-logo-url">最終スライドロゴURL:</label>
              <input 
                type="url" 
                id="closing-logo-url" 
                placeholder="https://example.com/logo.png"
                class="text-input"
              />
            </div>
            
          </div>
        </div>
      </div>
    </div>

      <!-- スライド生成ボタン（全体中央配置） -->
      <div class="btn-area-center">
        <button
          type="submit"
          id="slide-generate"
          class="submit-btn"
          onclick="handleSubmit(event)"
        >
          スライド生成
        </button>
      </div>

      <div id="loading">
        <div class="loading-content">
          <div class="spinner"></div>
          <p>作成中...</p>
          <button id="cancel-loading" onclick="cancelLoading()">
            キャンセル
          </button>
        </div>
      </div>
      <div id="custom-alert-overlay">
        <div id="custom-alert">
          <div class="alert-content">
            <p id="custom-alert-message">メッセージがここに表示されます</p>
            <button onclick="hideCustomAlert()">閉じる</button>
          </div>
        </div>
      </div>

      <div class="btn-area">
        <button
          id="link-to-slide"
          class="submit-btn"
          onclick="window.open('', '_blank');"
        >
          <!-- 出力されたGSlideのリンクが入る -->
          <span class="material-symbols-outlined"> open_in_new </span
          >スライドをチェック
        </button>
      </div>
    </div>
    <footer>© 2025 TOPPAN Inc. AI Powered Project.</footer>
  </body>
  <script>
    let isCancelled = false; // キャンセルフラグ

    // フォントファミリー選択時の処理
    function handleFontFamilyChange() {
      const fontFamilySelect = document.getElementById("font-family");
      const customFontInput = document.getElementById("custom-font-family");
      
      if (fontFamilySelect.value === "custom") {
        customFontInput.style.display = "block";
      } else {
        customFontInput.style.display = "none";
        customFontInput.value = ""; // カスタム入力をクリア
      }
    }

    // キャンセルボタンの処理
    function cancelLoading() {
      isCancelled = true; // キャンセルフラグを立てる
      const loadingElement = document.getElementById("loading");
      if (loadingElement) {
        loadingElement.style.display = "none"; // ローディング画面を非表示
      }
      showCustomAlert("処理がキャンセルされました。");
    }

    // スライドデータ生成関数
    function generateSlideData(userInput, options) {
      const loadingElement = document.getElementById("loading");
      const linkButton = document.getElementById("link-to-slide");

      isCancelled = false; // 処理開始時にキャンセルフラグをリセット

      google.script.run
        .withSuccessHandler((response) => {
          if (isCancelled) {
            console.log("キャンセルされたため処理を停止");
            return;
          }
          console.log("成功:", response);
          if (loadingElement) {
            loadingElement.style.display = "none";
          }
          showCustomAlert("スライド生成が完了しました！");
          // リンクを更新
          if (linkButton) {
            linkButton.onclick = () => window.open(response.url, "_blank");
            linkButton.style.display = "inline-flex";
          }
        })
        .withFailureHandler((error) => {
          if (isCancelled) {
            console.log("キャンセルされたためエラー処理を無視");
            return;
          }
          console.error("エラー:", error);
          if (loadingElement) {
            loadingElement.style.display = "none";
          }
          showCustomAlert("エラーが発生しました。もう一度お試しください。");
        })
        .runGeneration({ 
          prompt: userInput, 
          generateOption: undefined,
          primaryColor: options.primaryColor,
          footerText: options.footerText,
          headerLogoUrl: options.headerLogoUrl,
          closingLogoUrl: options.closingLogoUrl,
          fontFamily: options.fontFamily
        });

      google.script.run.outputLog(userInput, undefined, "slide-generate", {
        primaryColor: options.primaryColor,
        footerText: options.footerText,
        headerLogoUrl: options.headerLogoUrl,
        closingLogoUrl: options.closingLogoUrl,
        fontFamily: options.fontFamily
      });
    }

    async function handleSubmit(event) {
      event.preventDefault(); // フォーム送信のリロードを防止

      // 押されたボタンのIDを取得
      const buttonId = event.target.id;

      // リンクボタンを非表示
      const linkButton = document.getElementById("link-to-slide");
      if (linkButton) {
        linkButton.style.display = "none";
      }

      // ローディング画面を表示
      const loadingElement = document.getElementById("loading");
      if (loadingElement) {
        loadingElement.style.display = "flex";
      }

      // パラメータ取得
      const userInput = document.getElementById("prompt")?.value || undefined;
      
      // オプション値取得
      const primaryColor = document.getElementById("primary-color")?.value || "#111111";
      const footerText = document.getElementById("footer-text")?.value || "© TOPPAN Inc.";
      const headerLogoUrl = document.getElementById("header-logo-url")?.value || "";
      const closingLogoUrl = document.getElementById("closing-logo-url")?.value || "";
      const fontFamilySelect = document.getElementById("font-family")?.value || "Helvetica Neue";
      const customFontFamily = document.getElementById("custom-font-family")?.value || "";
      
      // フォントファミリーの最終値を決定
      const fontFamily = fontFamilySelect === "custom" && customFontFamily ? customFontFamily : fontFamilySelect;

      if (!userInput) {
        if (loadingElement) {
          loadingElement.style.display = "none";
        }
        showCustomAlert("テキストが未入力です。入力して再度実行してください。");
        return;
      }

      // ボタンIDに応じた処理
      if (buttonId === "slide-generate") {
        console.log("スライド生成を実行");
        
        // オプションをオブジェクトにまとめる
        const options = {
          primaryColor,
          footerText,
          headerLogoUrl,
          closingLogoUrl,
          fontFamily
        };

        // generateSlideData関数を呼び出し
        generateSlideData(userInput, options);
      } else {
        console.error("不明なボタンIDです");
        if (loadingElement) {
          loadingElement.style.display = "none";
        }
        showCustomAlert("不明な操作が行われました。再度お試しください。");
        return;
      }
    }

    // カスタムアラートを表示する
    function showCustomAlert(message) {
      const alertOverlay = document.getElementById("custom-alert-overlay");
      const alertMessageElement = document.getElementById(
        "custom-alert-message"
      );

      if (alertOverlay && alertMessageElement) {
        alertMessageElement.textContent = message; // メッセージを設定
        alertOverlay.style.display = "block"; // 半透明の膜とアラートを表示
      }
    }

    // カスタムアラートを非表示にする
    function hideCustomAlert() {
      const alertOverlay = document.getElementById("custom-alert-overlay");
      if (alertOverlay) {
        alertOverlay.style.display = "none"; // 非表示
      }
    }
  </script>
</html>

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SlideGenerator</title>
  </head>
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0..1,-25..0"
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400&family=Material+Symbols+Outlined&family=Reddit+Sans:wght@400;500&display=swap"
    rel="stylesheet"
  />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      color: #333;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      text-align: left;
      margin-bottom: 40px;
      margin-left: 0;
    }

    header h1 {
      font-family: "Reddit Sans", sans-serif;
      font-size: 1.4rem;
      font-weight: 400;
      letter-spacing: 0.1rem;
      color: rgb(127, 127, 127);
      margin: 0;
      padding-bottom: 5px;
    }

    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 35px; /* 固定高さ */
      text-align: center;
      font-size: 0.875rem;
      color: #6c757d;
      padding: 0.5rem 0;
      z-index: 10;
    }

    .container {
      margin: 0;
      background: #fff;
      padding: 30px;
      flex: 1;
    }
    
    .container h1 {
      padding: 5px 0;
      text-align: center;
      margin-bottom: 10px;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 20px;
      height: 100%;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .form-group textarea {
      width: 100%;
      height: 480px;
      resize: vertical;
      flex: 1;
    }

    textarea {
      width: 100%;
      padding: 15px 30px;
      font-size: 0.9rem;
      outline: none;
      background: #f4f4f4;
      transition: border-color 0.2s;
      color: #333;
      border: none;
      border-radius: 15px;
      line-height: 1.5;
    }
    textarea:focus {
      border-color: #333;
    }
    .btn-area {
      text-align: center;
      vertical-align: middle;
    }

    .btn-area-center {
      width: 100%;
      text-align: center;
      margin-top: 30px;
      margin-bottom: 30px;
    }

    .submit-btn {
      height: 50px;
      width: 180px;
      padding: 14px;
      background-color: #111;
      color: #fff;
      border: none;
      border-radius: 15px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.1s;
      letter-spacing: 0.5px;
      margin: 10px 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .submit-btn:hover {
      transform: scale(1.05);
    }
    .submit-btn:active {
      transform: scale(0.98);
    }

    #link-to-slide {
      width: 400px;
      background-color: #ffdd00;
      color: #111;
      font-weight: bold;
      margin-top: 20px;
      display: none;
    }

    /* ローディング */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8); /* 半透明の白 */
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .loading-content {
      text-align: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 6px solid rgba(0, 0, 0, 0.2); /* 薄い枠 */
      border-top: 6px solid #111; /* 濃い部分 */
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto; /* 中央揃え */
    }

    #loading p {
      margin-top: 10px;
      font-size: 1rem;
      color: #333;
    }

    /* 進捗表示詳細 */
    #progress-details {
      margin-top: 15px;
    }

    #current-step {
      font-size: 0.9rem;
      color: #555;
      margin-top: 5px;
      font-style: italic;
    }

    /* キャンセルボタン */
    #loading button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #ff5722;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
      font-size: 1rem;
    }

    #loading button:hover {
      background-color: #e64a19;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    /* カスタムアラート */
    #custom-alert-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8); /* 半透明の白 */
      z-index: 999; /* 他の要素の上に表示 */
      display: none; /* 初期状態では非表示 */
    }

    #custom-alert {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000; /* 膜の上に配置 */
      background: rgba(0, 0, 0, 0.8); /* 黒背景 */
      color: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    #custom-alert .alert-content {
      text-align: center;
    }

    #custom-alert button {
      margin-top: 25px;
      padding: 10px 15px;
      background-color: #ff5722;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }

    #custom-alert button:hover {
      background-color: #e64a19;
    }

    /* ページレイアウト */
    body {
      margin: 0;
      padding: 24px;
    }

    /* 旧アプリボタン */
    .old-app-button {
      padding: 6px 12px;
      font-size: 0.75rem;
      background-color: #f8f9fa;
      color: #6c757d;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
      font-family: inherit;
    }

    .old-app-button:hover {
      background-color: #e9ecef;
      color: #495057;
    }

    .old-app-button:active {
      background-color: #dee2e6;
      transform: translateY(1px);
    }

    .page-title {
      text-align: center;
      margin: 20px 0 30px 0;
      padding: 0 24px;
    }

    .page-title h1 {
      font-size: 1.6rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .page-layout {
      display: grid;
      grid-template-columns: 3fr 2fr;
      gap: 20px;
    }

    .sidebar {
      width: 100%;
      padding: 24px 24px 24px 0;
      display: flex;
      flex-direction: column;
    }

    .main-area {
      display: flex;
      flex-direction: column;
    }

    /* サイドバーオプションのスタイリング */
    .options-section {
      background: #f4f4f4;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 480px;
    }

    .options-title {
      font-family: "Reddit Sans", sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      color: #555;
      margin-bottom: 14px;
      text-align: center;
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 8px;
    }

    .options-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
      justify-content: flex-start;
    }

    .options-list .form-group {
      display: flex;
      flex-direction: column;
    }

    .options-list label {
      display: block;
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }

    /* ボタン付きラベルの間隔を調整 */
    .options-list label:has(button) {
      margin-bottom: 12px;
    }

    .text-input,
    .select-input {
      width: 100%;
      padding: 12px 12px;
      font-size: 0.75rem;
      outline: none;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      color: #333;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .text-input:focus,
    .select-input:focus {
      border-color: #111;
      box-shadow: 0 0 0 2px rgba(17, 17, 17, 0.1);
    }

    input[type="color"] {
      width: 0;
      height: 0;
      opacity: 0;
      position: absolute;
      pointer-events: none;
      border: none;
      padding: 0;
      margin: 0;
    }

    input[type="color"]::-webkit-color-swatch-wrapper {
      display: none;
    }

    input[type="color"]::-webkit-color-swatch {
      display: none;
    }

    /* カラーボタンのスタイル */
    .color-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }

    .color-btn {
      width: 28px;
      height: 28px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .color-btn:hover {
      transform: scale(1.1);
      border-color: #333;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .color-btn.active {
      border-color: #333;
      border-width: 3px;
      box-shadow: 0 0 0 2px rgba(51, 51, 51, 0.2);
    }

    .custom-color-btn {
      width: 28px;
      height: 28px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .custom-color-btn:hover {
      transform: scale(1.1);
      border-color: #333;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .custom-color-btn span {
      color: #666;
      font-size: 14px;
    }

    /* レスポンシブ対応 */
    @media (max-width: 768px) {
      body {
        grid-template-rows: auto auto 1fr;
      }

      .page-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }

      .sidebar {
        order: 2;
        padding: 20px 24px;
      }

      .main-area {
        order: 1;
      }

      header {
        padding: 20px 0 15px 24px;
      }

      .form-group textarea {
        height: 320px;
      }

      .options-section {
        padding: 14px;
      }

      .options-title {
        font-size: 0.8rem;
        margin-bottom: 12px;
      }

      .options-list {
        gap: 10px;
      }
    }

    @media (max-width: 600px) {
      .sidebar {
        padding: 15px 20px;
      }

      .container {
        padding: 20px;
      }

      .form-group textarea {
        height: 280px;
        padding: 12px 15px;
        font-size: 0.85rem;
      }

      .options-section {
        padding: 12px;
      }

      .text-input,
      .select-input {
        padding: 10px 10px;
        font-size: 0.7rem;
      }

      .options-list label {
        font-size: 0.7rem;
        margin-bottom: 6px;
      }

      /* モバイル版でもボタン付きラベルの間隔を調整 */
      .options-list label:has(button) {
        margin-bottom: 8px;
      }

      .options-list {
        gap: 8px;
      }

      /* モバイル版でのカラーボタン調整 */
      .color-buttons {
        gap: 6px;
      }

      .color-btn,
      .custom-color-btn {
        width: 24px;
        height: 24px;
      }

      .custom-color-btn span {
        font-size: 12px;
      }

      header {
        padding: 16px 0 12px 20px;
      }

      header h1 {
        font-size: 1.2rem;
      }
    }
  </style>
  <body>
    <header>
      <h1>SlideGenerator</h1>
      <button id="old-app-btn" class="old-app-button" onclick="openOldApp()" title="アップデート前のアプリを利用されたい方はこちら">旧アプリを使用</button>
    </header>
    
    <!-- ページタイトル -->
    <div class="page-title">
      <h1>プレゼンテーションのイメージを教えてください</h1>
    </div>
    
    <div class="page-layout">
      <!-- 左: メインエリア -->
      <div class="main-area">
        <div class="container">
          <form onsubmit="event.preventDefault();">
            
            <div class="form-group">
              <textarea
              id="prompt"
              rows="15"
              placeholder="作成したいプレゼンテーションの内容を入力してください。
              
  スライドに含めたい内容をできるだけ細かく記述してください。
  メモ書きをそのまま貼り付けても実行できます。
    例）生成AIとは
    1. 生成AIの仕組み
    2. 生成AIでできる10のこと
    文章作成
    アイディア出し
  ..."
  ></textarea>
</div>
</form>
</div>
</div>

<!-- 右: サイドバー -->
<div class="sidebar">
        <div class="options-section">          
          <div class="options-list">
            <!-- primaryColor -->
            <div class="form-group">
              <label for="primary-color">メインカラー</label>
              <div class="color-buttons">
                <button type="button" class="color-btn active" onclick="setColor('#145599', this)" style="background-color: #145599;" title="デフォルト"></button>
                <button type="button" class="color-btn" onclick="setColor('#4F46E5', this)" style="background-color: #4F46E5;" title="Indigo"></button>
                <button type="button" class="color-btn" onclick="setColor('#7C3AED', this)" style="background-color: #7C3AED;" title="Violet"></button>
                <button type="button" class="color-btn" onclick="setColor('#C026D3', this)" style="background-color: #C026D3;" title="Fuchsia"></button>
                <button type="button" class="color-btn" onclick="setColor('#0284C7', this)" style="background-color: #0284C7;" title="Sky"></button>
                <button type="button" class="color-btn" onclick="setColor('#0D9488', this)" style="background-color: #0D9488;" title="Teal"></button>
                <button type="button" class="color-btn" onclick="setColor('#F97316', this)" style="background-color: #F97316;" title="Orange"></button>
                <button type="button" class="color-btn" onclick="setColor('#E11D48', this)" style="background-color: #E11D48;" title="Rose"></button>
                <button type="button" class="custom-color-btn" onclick="showCustomColorPicker()" title="カスタムカラー">
                  <span class="material-symbols-outlined">palette</span>
                </button>
              </div>
              <input type="color" id="primary-color" value="#145599" style="display: none;" />
            </div>
            <!-- fontFamily -->
            <div class="form-group">
              <label for="font-family">フォント</label>
              <select id="font-family" class="select-input" onchange="handleFontFamilyChange()">
                <option value="Arial">Arial</option>
                <option value="BIZ UDPGothic">BIZ UDPGothic</option>
                <option value="Noto Sans JP">Noto Sans JP</option>
                <option value="IBM Plex Sans JP">IBM Plex Sans JP</option>
                <option value="Zen Kaku Gothic New">Zen Kaku Gothic New</option>
                <option value="Noto Serif JP">Noto Serif JP</option>
                <option value="Zen Kaku Gothic Antique">Zen Kaku Gothic Antique</option>
                <option value="M PLUS 1p">M PLUS 1p</option>
                <option value="Shippori Mincho">Shippori Mincho</option>
                <option value="Murecho">Murecho</option>
                <option value="Zen Maru Gothic">Zen Maru Gothic</option>
                <option value="M PLUS Rounded 1c">M PLUS Rounded 1c</option>
                <option value="Kaisei Opti">Kaisei Opti</option>
                <option value="Hina Mincho">Hina Mincho</option>
                <option value="Kaisei Decol">Kaisei Decol</option>
                <option value="Dela Gothic One">Dela Gothic One</option>
                <option value="custom">その他（カスタム入力）</option>
              </select>
              <input
                type="text"
                id="custom-font-family"
                placeholder="フォントファミリー名を正確に入力"
                class="text-input"
                style="display: none; margin-top: 8px;"
              />
            </div>

            
            <!-- footerText -->
            <div class="form-group">
              <label for="footer-text">フッターテキスト</label>
              <input 
                type="text" 
                id="footer-text" 
                placeholder="© TOPPAN Inc." 
                value="© TOPPAN Inc."
                class="text-input"
              />
            </div>
            
            <!-- headerLogoUrl -->
            <div class="form-group">
              <label for="header-logo-url">ヘッダーロゴURL 
                <button type="button" onclick="setToppanLogoUrl('header-logo-url')" style="background:#145599;border:none;color:white;cursor:pointer;font-size:0.7rem;padding:4px 8px;border-radius:4px;float:right;margin-left:10px;">TOPPANロゴを使用</button>
              </label>
              <input 
                type="url" 
                id="header-logo-url" 
                placeholder="https://example.com/logo.png（画像の公開URLを貼付）"
                class="text-input"
              />
            </div>
            
            <!-- closingLogoUrl -->
            <div class="form-group">
              <label for="closing-logo-url">最終スライドロゴURL
                <button type="button" onclick="setToppanLogoUrl('closing-logo-url')" style="background:#145599;border:none;color:white;cursor:pointer;font-size:0.7rem;padding:4px 8px;border-radius:4px;float:right;margin-left:10px;">TOPPANロゴを使用</button>
              </label>
              <input 
                type="url" 
                id="closing-logo-url" 
                placeholder="https://example.com/logo.png（画像の公開URLを貼付）"
                class="text-input"
              />
            </div>
            
          </div>
        </div>
      </div>
    </div>

      <!-- スライド生成ボタン（全体中央配置） -->
      <div class="btn-area-center">
        <button
          type="submit"
          id="slide-generate"
          class="submit-btn"
          onclick="handleSubmit(event)"
        >
          スライド生成
        </button>
      </div>

      <div id="loading">
        <div class="loading-content">
          <div class="spinner"></div>
          <p id="progress-message"></p>
          <div id="progress-details">
            <p id="current-step">処理を開始しています...</p>
          </div>
          <button id="cancel-loading" onclick="cancelLoading()">
            キャンセル
          </button>
        </div>
      </div>
      <div id="custom-alert-overlay">
        <div id="custom-alert">
          <div class="alert-content">
            <p id="custom-alert-message">メッセージがここに表示されます</p>
            <button onclick="hideCustomAlert()">閉じる</button>
          </div>
        </div>
      </div>

      <div class="btn-area">
        <button
          id="link-to-slide"
          class="submit-btn"
          onclick="window.open('', '_blank');"
        >
          <!-- 出力されたGSlideのリンクが入る -->
          <span class="material-symbols-outlined"> open_in_new </span
          >スライドをチェック
        </button>
      </div>
    </div>
    <footer>© 2025 TOPPAN Inc. AI Powered Project.</footer>
  </body>
  <script>
    let isCancelled = false; // キャンセルフラグ

    // 旧アプリを新規タブで開く
    function openOldApp() {
      window.open('https://script.google.com/a/macros/toppan.co.jp/s/AKfycbwzKtXGXlIYmz39nENL4YTxNlksseujJhOM0KNEaH09nSms9_CWdDUYqmXNYXrsloo/exec', '_blank');
    }

    // フォントファミリー選択時の処理
    function handleFontFamilyChange() {
      const fontFamilySelect = document.getElementById("font-family");
      const customFontInput = document.getElementById("custom-font-family");
      
      if (fontFamilySelect.value === "custom") {
        customFontInput.style.display = "block";
      } else {
        customFontInput.style.display = "none";
        customFontInput.value = ""; // カスタム入力をクリア
      }
    }

    // TOPPANロゴURLを設定する関数
    function setToppanLogoUrl(inputId) {
      const toppanLogoUrl = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQaWj9IAldlS2r14RkWuKTyOvLs2csIH8rsxA&s";
      const inputElement = document.getElementById(inputId);
      if (inputElement) {
        inputElement.value = toppanLogoUrl;
      }
    }

    // キャンセルボタンの処理
    function cancelLoading() {
      isCancelled = true; // キャンセルフラグを立てる
      stopProgressUpdater(); // 進捗更新を停止
      
      const loadingElement = document.getElementById("loading");
      if (loadingElement) {
        loadingElement.style.display = "none"; // ローディング画面を非表示
      }
      showCustomAlert("処理がキャンセルされました。");
    }

    // 進捗メッセージのリスト
    const progressMessages = [
      "処理を開始しています...",
      "プロンプトを準備中...",
      "Gemini APIでスライド構成を作成中...",
      "データを検証・正規化中...",
      "プレゼンテーションを生成中...",
      "最終処理中..."
    ];

    let progressIndex = 0;
    let progressTimer = null;

    // 進捗を更新する関数
    function updateProgress(message) {
      const progressElement = document.getElementById("current-step");
      if (progressElement) {
        progressElement.textContent = message;
      }
      console.log(`進捗: ${message}`);
    }

    // 自動進捗更新を開始
    function startProgressUpdater() {
      progressIndex = 0;
      updateProgress(progressMessages[progressIndex]);
      
      progressTimer = setInterval(() => {
        progressIndex++;
        if (progressIndex < progressMessages.length) {
          updateProgress(progressMessages[progressIndex]);
        } else {
          clearInterval(progressTimer);
          progressTimer = null;
        }
      }, 3000); // 3秒ごとに進捗を更新
    }

    // 自動進捗更新を停止
    function stopProgressUpdater() {
      if (progressTimer) {
        clearInterval(progressTimer);
        progressTimer = null;
      }
    }

    // スライドデータ生成関数
    function generateSlideData(userInput, options) {
      const loadingElement = document.getElementById("loading");
      const linkButton = document.getElementById("link-to-slide");

      isCancelled = false; // 処理開始時にキャンセルフラグをリセット
      
      // 自動進捗更新開始
      startProgressUpdater();

      google.script.run
        .withSuccessHandler((response) => {
          stopProgressUpdater(); // 進捗更新を停止
          
          if (isCancelled) {
            console.log("キャンセルされたため処理を停止");
            return;
          }
          console.log("成功:", response);
          if (loadingElement) {
            loadingElement.style.display = "none";
          }
          showCustomAlert("スライド生成が完了しました！");
          // リンクを更新
          if (linkButton) {
            linkButton.onclick = () => window.open(response, "_blank"); // リンクをGoogle Apps Scriptの結果に設定
            linkButton.style.display = "inline-flex";
          }
        })
        .withFailureHandler((error) => {
          stopProgressUpdater(); // 進捗更新を停止
          
          if (isCancelled) {
            console.log("キャンセルされたためエラー処理を無視");
            return;
          }
          
          updateProgress("エラーが発生しました");
          console.error("エラー:", error);
          
          if (loadingElement) {
            loadingElement.style.display = "none";
          }
          showCustomAlert(`エラーが発生しました: ${error.message || error}`);
        })
        .generateSlideData(userInput, options);
    }

    async function handleSubmit(event) {
      event.preventDefault(); // フォーム送信のリロードを防止

      // 押されたボタンのIDを取得
      const buttonId = event.target.id;

      // リンクボタンを非表示
      const linkButton = document.getElementById("link-to-slide");
      if (linkButton) {
        linkButton.style.display = "none";
      }

      // ローディング画面を表示
      const loadingElement = document.getElementById("loading");
      if (loadingElement) {
        loadingElement.style.display = "flex";
      }

      // パラメータ取得
      const userInput = document.getElementById("prompt")?.value || undefined;
      
      // オプション値取得
      const primaryColor = document.getElementById("primary-color")?.value || "#145599";
      const footerText = document.getElementById("footer-text")?.value || "© TOPPAN Inc.";
      const headerLogoUrlValue = document.getElementById("header-logo-url")?.value?.trim();
      const closingLogoUrlValue = document.getElementById("closing-logo-url")?.value?.trim();
      
      // 空欄の場合はnullを設定（画像を配置しない）
      const headerLogoUrl = headerLogoUrlValue || null;
      const closingLogoUrl = closingLogoUrlValue || null;
      const fontFamilySelect = document.getElementById("font-family")?.value || "BIZ UDPGothic";
      const customFontFamily = document.getElementById("custom-font-family")?.value || "";
      
      // フォントファミリーの最終値を決定
      const fontFamily = fontFamilySelect === "custom" && customFontFamily ? customFontFamily : fontFamilySelect;

      if (!userInput) {
        if (loadingElement) {
          loadingElement.style.display = "none";
        }
        showCustomAlert("テキストが未入力です。入力して再度実行してください。");
        return;
      }

      // ボタンIDに応じた処理
      if (buttonId === "slide-generate") {
        console.log("スライド生成を実行");
        
        // オプションをオブジェクトにまとめる
        const options = {
          primaryColor,
          footerText,
          headerLogoUrl,
          closingLogoUrl,
          fontFamily
        };

        // generateSlideData関数を呼び出し
        generateSlideData(userInput, options);
      } else {
        console.error("不明なボタンIDです");
        if (loadingElement) {
          loadingElement.style.display = "none";
        }
        showCustomAlert("不明な操作が行われました。再度お試しください。");
        return;
      }
    }

    // カスタムアラートを表示する
    function showCustomAlert(message) {
      const alertOverlay = document.getElementById("custom-alert-overlay");
      const alertMessageElement = document.getElementById(
        "custom-alert-message"
      );

      if (alertOverlay && alertMessageElement) {
        alertMessageElement.textContent = message; // メッセージを設定
        alertOverlay.style.display = "block"; // 半透明の膜とアラートを表示
      }
    }

    // カスタムアラートを非表示にする
    function hideCustomAlert() {
      const alertOverlay = document.getElementById("custom-alert-overlay");
      if (alertOverlay) {
        alertOverlay.style.display = "none"; // 非表示
      }
    }

    // カラーボタン関連の関数
    function setColor(colorCode, buttonElement) {
      // 隠しカラーピッカーに値を設定
      const colorInput = document.getElementById("primary-color");
      if (colorInput) {
        colorInput.value = colorCode;
      }
      
      // すべてのカラーボタンからactiveクラスを除去
      const allColorBtns = document.querySelectorAll(".color-btn");
      allColorBtns.forEach(btn => btn.classList.remove("active"));
      
      // クリックされたボタンにactiveクラスを追加
      if (buttonElement) {
        buttonElement.classList.add("active");
      }
      
      console.log(`色が変更されました: ${colorCode}`);
    }

    // 色の明度を判定するヘルパー関数
    function isColorDark(hexColor) {
      // HEXからRGBに変換
      const r = parseInt(hexColor.substr(1, 2), 16);
      const g = parseInt(hexColor.substr(3, 2), 16);
      const b = parseInt(hexColor.substr(5, 2), 16);
      
      // 相対輝度を計算 (ITU-R BT.709)
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      
      // 0.5未満なら暗い色とみなす
      return luminance < 0.5;
    }

    function showCustomColorPicker() {
      const colorInput = document.getElementById("primary-color");
      const customColorBtn = document.querySelector(".custom-color-btn");
      
      if (colorInput && customColorBtn) {
        // カスタムボタンの位置を取得
        const btnRect = customColorBtn.getBoundingClientRect();
        
        // カラーピッカーを表示して画面外に配置（非表示）
        colorInput.style.display = "block";
        colorInput.style.position = "absolute";
        colorInput.style.left = "-9999px";
        colorInput.style.top = "-9999px";
        colorInput.style.zIndex = "1000";
        colorInput.click();
        
        // 色が選択されたときの処理
        colorInput.addEventListener("change", function handleColorChange() {
          const selectedColor = this.value;
          
          // すべてのカラーボタンからactiveクラスを除去
          const allColorBtns = document.querySelectorAll(".color-btn");
          allColorBtns.forEach(btn => btn.classList.remove("active"));
          
          // カスタムボタンの背景色を選択した色に変更
          customColorBtn.style.backgroundColor = selectedColor;
          
          // アイコンの色を選択した色の明度に応じて調整
          const iconSpan = customColorBtn.querySelector("span");
          if (iconSpan) {
            if (isColorDark(selectedColor)) {
              iconSpan.style.color = "#ffffff";
            } else {
              iconSpan.style.color = "#333333";
            }
          }
          
          console.log(`カスタム色が選択されました: ${selectedColor}`);
          
          // カラーピッカーを再び非表示に
          this.style.display = "none";
          
          // イベントリスナーを削除（重複防止）
          this.removeEventListener("change", handleColorChange);
        }, { once: true });
      }
    }
  </script>
</html>
